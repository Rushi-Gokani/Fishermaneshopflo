{%- comment -%}
  Product Card Image - Modern
  Displays product image with swipeable image gallery
{%- endcomment -%}

{%- liquid
  assign first_variant = product.selected_or_first_available_variant
  assign image_count = product.media.size | at_most: 5
-%}

<card-slider-image class="fph-image-container" data-total-images="{{ image_count }}" data-product-url="{{ product.url }}">
  {% if product.media.size > 0 %}
    {% for media in product.media limit: 5 %}
      {% if media.media_type == 'image' %}
        {{
          media
          | image_url: width: 600
          | image_tag:
            loading: 'lazy',
            class: 'fph-slide-image',
            alt: media.alt,
            widths: '300, 400, 600, 800',
            sizes: '(max-width: 300px) 300px, (max-width: 480px) 400px, (max-width: 600px) 600px'
        }}
      {% endif %}
    {% endfor %}
  {% else %}
    <div class="fph-image-placeholder">
      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
    </div>
  {% endif %}

  {% if product.media.size > 1 %}
    <div class="fph-image-dots">
      {% for media in product.media limit: 5 %}
        {% if media.media_type == 'image' %}
          <span class="fph-dot {% if forloop.first %}active{% endif %}" data-index="{{ forloop.index0 }}"></span>
        {% endif %}
      {% endfor %}
    </div>
  {% endif %}
</card-slider-image>

{% stylesheet %}
  .fph-image-container {
    width: 100%;
    height: 100%;
    position: relative;
    overflow: hidden;
    touch-action: pan-x;
    display: flex;
    align-items: center;
  }

  .fph-slide-image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    flex-shrink: 0;
    pointer-events: none;
    user-select: none;
    -webkit-user-select: none;
  }

  .fph-image-placeholder {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f5f5f5;
  }

  .fph-image-placeholder svg {
    width: 50%;
    height: 50%;
  }

  .fph-image-dots {
    position: absolute;
    bottom: 8px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 4px;
    z-index: 2;
  }

  .fph-dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.5);
    transition: background 0.2s, transform 0.2s;
  }

  .fph-dot.active {
    background: #000;
    transform: scale(1.3);
  }

  @media screen and (max-width: 749px) {
    .fph-image-container {
      touch-action: none;
    }
  }
{% endstylesheet %}

<script>
(function() {
  class CardSliderImage extends HTMLElement {
    constructor() {
      super();
      this.currentIndex = 0;
      this.isDragging = false;
      this.startX = 0;
      this.currentTranslate = 0;
      this.prevTranslate = 0;
      this.images = [];
    }

    connectedCallback() {
      this.images = Array.from(this.querySelectorAll('.fph-slide-image'));
      this.dots = Array.from(this.querySelectorAll('.fph-dot'));

      if (this.images.length <= 1) return;

      // Initial position
      this.updateSlider();

      // Touch events
      this.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
      this.addEventListener('touchmove', this.handleTouchMove.bind(this), { passive: false });
      this.addEventListener('touchend', this.handleTouchEnd.bind(this), { passive: true });
      this.addEventListener('touchcancel', this.handleTouchEnd.bind(this), { passive: true });

      // Mouse events for desktop
      this.addEventListener('mousedown', this.handleMouseDown.bind(this));

      // Click on dot
      this.dots.forEach((dot, index) => {
        dot.addEventListener('click', (e) => {
          e.stopPropagation();
          e.preventDefault();
          this.goToSlide(index);
        });
      });

      console.log('[CardSliderImage] Initialized', { images: this.images.length });
    }

    updateSlider() {
      if (!this.images.length) return;

      this.images.forEach((img, i) => {
        img.style.transform = `translateX(${(i - this.currentIndex) * 100}%)`;
        img.style.transition = this.isDragging ? 'none' : 'transform 0.3s ease-out';
      });

      // Update dots
      this.dots.forEach((dot, i) => {
        dot.classList.toggle('active', i === this.currentIndex);
      });
    }

    goToSlide(index) {
      if (index < 0) index = this.images.length - 1;
      if (index >= this.images.length) index = 0;
      this.currentIndex = index;
      this.prevTranslate = this.currentIndex * -100;
      this.updateSlider();
    }

    handleTouchStart(e) {
      if (this.images.length <= 1) return;
      this.isDragging = true;
      this.startX = e.touches[0].clientX;
      this.prevTranslate = this.currentIndex * -100;
      console.log('[CardSliderImage] Touch start', { currentIndex: this.currentIndex, startX: this.startX });
    }

    handleTouchMove(e) {
      if (!this.isDragging) return;

      const currentX = e.touches[0].clientX;
      const diff = currentX - this.startX;
      this.currentTranslate = this.prevTranslate + (diff / this.offsetWidth) * 100;

      this.images.forEach((img, i) => {
        img.style.transform = `translateX(${(i * 100) + this.currentTranslate}%)`;
        img.style.transition = 'none';
      });

      if (Math.abs(diff) > 10) {
        e.preventDefault();
      }
    }

    handleTouchEnd(e) {
      if (!this.isDragging) return;
      this.isDragging = false;

      const endX = e.changedTouches[0].clientX;
      const diff = endX - this.startX;

      console.log('[CardSliderImage] Touch end', { diff, currentIndex: this.currentIndex });

      if (Math.abs(diff) > 50) {
        if (diff < 0 && this.currentIndex < this.images.length - 1) {
          this.goToSlide(this.currentIndex + 1);
        } else if (diff > 0 && this.currentIndex > 0) {
          this.goToSlide(this.currentIndex - 1);
        } else {
          this.goToSlide(this.currentIndex);
        }
      } else {
        this.goToSlide(this.currentIndex);
      }
    }

    handleMouseDown(e) {
      if (this.images.length <= 1) return;
      this.isDragging = true;
      this.startX = e.clientX;
      this.prevTranslate = this.currentIndex * -100;

      const onMove = (e) => {
        if (!this.isDragging) return;
        const currentX = e.clientX;
        const diff = currentX - this.startX;
        this.currentTranslate = this.prevTranslate + (diff / this.offsetWidth) * 100;

        this.images.forEach((img, i) => {
          img.style.transform = `translateX(${(i * 100) + this.currentTranslate}%)`;
          img.style.transition = 'none';
        });
      };

      const onUp = (e) => {
        this.isDragging = false;
        document.removeEventListener('mousemove', onMove);
        document.removeEventListener('mouseup', onUp);

        const endX = e.clientX;
        const diff = endX - this.startX;

        if (Math.abs(diff) > 50) {
          if (diff < 0 && this.currentIndex < this.images.length - 1) {
            this.goToSlide(this.currentIndex + 1);
          } else if (diff > 0 && this.currentIndex > 0) {
            this.goToSlide(this.currentIndex - 1);
          } else {
            this.goToSlide(this.currentIndex);
          }
        } else {
          this.goToSlide(this.currentIndex);
        }
      };

      document.addEventListener('mousemove', onMove);
      document.addEventListener('mouseup', onUp);
    }
  }

  if (!customElements.get('card-slider-image')) {
    customElements.define('card-slider-image', CardSliderImage);
  }

  console.log('[CardSliderImage] Script loaded');
})();
</script>
